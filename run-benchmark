#!/bin/bash
usage() {
    echo "Usage: ${0} bindir outdir module.bc"
    echo "<bindir> will contain module.elf, module.elf.pml and module.elf.bc"
    echo "<outdir> will contain module.{ais,xml,apx,..}"
    exit 1
}

if [ -z "${3}" ] ; then usage ; fi

BINDIR="${1}"
OUTDIR="${2}"
BC="${3}"
BENCHMARK="${4}"
if [ -z "${BENCHMARK}" ] ; then BENCHMARK="bench" ; fi

M=$(basename "${BC}" .bc)
ELF="${BINDIR}/${M}.elf"
PML="${BINDIR}/${M}.elf.pml"

if [ ! -e "${BC}" ] ; then echo "${BC} not found" ; usage ; fi

# compile (XXX: this will be just a call two clang)
ruby1.9.1 platin-demo -O "${BINDIR}" "${BC}" --steps 1..3 2>/dev/null
if [ $? -ne 0 ] ; then
    echo "Compilation failed (${BINDIR}/${M}.log)"
    exit 1
fi

# analyze
MO="${OUTDIR}/${M}"
./platin "${BENCHMARK}" "${PML}" \
    --ais "${MO}.ais" \
    --binary "${ELF}" \
    --report "${MO}.txt" \
    --apx "${MO}.apx" \
    --results "${MO}.xml" \
    --header \
    --analysis-entry main
