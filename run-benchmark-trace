#!/bin/bash
usage() {
    echo "Usage: ${0} bindir outdir module.bc"
    echo "<bindir> will contain module.elf, module.elf.pml and module.elf.bc"
    echo "<outdir> will contain module.{ais,xml,apx,..}"
    echo "PATMOS_CFLAGS is passed to patmos-clang"
    exit 1
}

if [ -z "${3}" ] ; then usage ; fi

BINDIR="${1}"
OUTDIR="${2}"
BC="${3}"
BENCHMARK="bench-trace"

M=$(basename "${BC}" .bc)
ELF="${BINDIR}/${M}.elf"
PML="${BINDIR}/${M}.elf.pml"
ELFBC="${BINDIR}/${M}.elf.bc"
if [ -z "${PATMOS_CFLAGS}" ] ; then
    PATMOS_CFLAGS="-O1"
fi
if [ ! -e "${BC}" ] ; then echo "${BC} not found" ; usage ; fi
if [ -z "`which patmos-clang`" ] ; then echo "patmos-clang command not found" ; exit 1 ; fi
set -x
patmos-clang ${PATMOS_CFLAGS} -o "${ELF}" -mpatmos-preemit-bitcode="${ELFBC}" -mpatmos-serialize="${PML}" "${BC}"
set +x
if [ $? -ne 0 ] ; then
    echo "Compilation failed (${BINDIR}/${M}.log)"
    exit 1
fi

# analyze
MO="${OUTDIR}/${M}"
./platin "${BENCHMARK}" "${PML}" \
    --output "${MO}.pml" \
    --ais "${MO}.ais" \
    --binary "${ELF}" \
    --report "${MO}.txt" \
    --apx "${MO}.apx" \
    --results "${MO}.xml" \
    --header \
    --analysis-entry main
